<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Modifying integrators · BSeries.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://ranocha.github.io/BSeries.jl/stable/tutorials/modifying_integrators/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">BSeries.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../modified_equations/">Modified equations</a></li><li class="is-active"><a class="tocitem" href>Modifying integrators</a><ul class="internal"><li><a class="tocitem" href="#Lotka-Volterra-model"><span>Lotka-Volterra model</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../symbolic_computations/">Symbolic computations</a></li></ul></li><li><a class="tocitem" href="../../benchmarks/">Benchmarks</a></li><li><a class="tocitem" href="../../api_reference/">API reference</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../license/">License</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Modifying integrators</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Modifying integrators</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ranocha/BSeries.jl/blob/master/docs/src/tutorials/modifying_integrators.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="tutorial-modifying-integrator"><a class="docs-heading-anchor" href="#tutorial-modifying-integrator">Modifying integrators</a><a id="tutorial-modifying-integrator-1"></a><a class="docs-heading-anchor-permalink" href="#tutorial-modifying-integrator" title="Permalink"></a></h1><p>This tutorial describes the API of <a href="https://github.com/ranocha/BSeries.jl">BSeries.jl</a> related to the notion of <em>modifying integrators</em>. The main API entry point is <a href="../../api_reference/#BSeries.modifying_integrator-Tuple{AbstractMatrix{T} where T, AbstractVector{T} where T, AbstractVector{T} where T, Any}"><code>modifying_integrator</code></a>.</p><p>Given a first-order autonomous ordinary differential equation (ODE)</p><p class="math-container">\[u&#39;(t) = f(u(t))\]</p><p>and a B-series time integration method, the idea is to find a modified ODE</p><p class="math-container">\[u&#39;(t) = f_h(u(t))\]</p><p>such that the numerical solution with given time step size <span>$h$</span> of the original ODE is the exact solution of the modified ODE, see <sup class="footnote-reference"><a id="citeref-ChartierHairerVilmart2007" href="#footnote-ChartierHairerVilmart2007">[ChartierHairerVilmart2007]</a></sup> and <sup class="footnote-reference"><a id="citeref-ChartierHairerVilmart2010" href="#footnote-ChartierHairerVilmart2010">[ChartierHairerVilmart2010]</a></sup>.</p><h2 id="Lotka-Volterra-model"><a class="docs-heading-anchor" href="#Lotka-Volterra-model">Lotka-Volterra model</a><a id="Lotka-Volterra-model-1"></a><a class="docs-heading-anchor-permalink" href="#Lotka-Volterra-model" title="Permalink"></a></h2><p>Here, we consider the explicit Euler method to solve the classical Lotka-Volterra model</p><p class="math-container">\[p&#39;(t) = (2 - q) p,
\quad
q&#39;(t) = (p - 1) q.\]</p><p>First, we set up the ODE and compute some numerical solutions using <a href="https://github.com/SciML/OrdinaryDiffEq.jl">OrdinaryDiffEq.jl</a>.</p><pre><code class="language-julia hljs">using OrdinaryDiffEq

function f(du, u, params, t)
  p, q = u
  dp = (2 - q) * p
  dq = (p - 1) * q
  du[1] = dp; du[2] = dq
  return nothing
end

u0 = [1.5, 2.25]
tspan = (0.0, 15.0)
ode = ODEProblem(f, u0, tspan)

dt = 0.35
sol_euler = solve(ode, Euler(), dt=dt)
sol_ref = solve(ode, Tsit5())</code></pre><p>Next, we look at some phase space plots of the numerical solution.</p><pre><code class="language-julia hljs">using LaTeXStrings, Plots

fig = plot(xguide=L&quot;$q$&quot;, yguide=L&quot;$p$&quot;)
default(linewidth=2)
plot!(fig, sol_ref, vars=(2, 1), label=&quot;Reference solution&quot;)
scatter!(fig, last.(sol_euler.u), first.(sol_euler.u),
         label=&quot;Explicit Euler, dt = $dt&quot;)
plot!(fig, xlims=(0.0, 4.0), ylims=(0.0, 2.5))</code></pre><p><img src="../lotka_volterra_original.svg" alt/></p><p>The exact solution of this problem is periodic, but the explicit Euler method produces an unstable trajectory. Here, we used an especially large time step to more clearly illustrate what will follow, but the qualitative behavior is the same for any time step size.</p><p>Next, we will derive a &quot;modifying integrator&quot;. What this means is that we will determine a perturbed ODE right-hand side (RHS) such that when Euler&#39;s method is applied to the perturbed RHS, the result is the exact solution to the original Lotka-Volterra system. The perturbed system takes the form of a power series in the time step size <code>dt</code>, and in order to compute with it we will truncate it at a certain order. We can compare the accuracy (and qualitative behavior) obtained by truncating at different orders.</p><p>Here, we use <a href="https://github.com/JuliaSymbolics/Symbolics.jl">Symbolics.jl</a> for the symbolic computations.</p><pre><code class="language-julia hljs">using BSeries, StaticArrays, Symbolics

# Explicit Euler method
A = @SArray [0//1;]
b = @SArray [1//1]
c = @SArray [0//1]

# Setup of symbolic variables
@variables dt_sym
u_sym = @variables p q
f_sym = similar(u_sym); f(f_sym, u_sym, nothing, nothing)

for truncation_order in 2:4
  series = modifying_integrator(f_sym, u_sym, dt_sym, A, b, c, truncation_order)
  series = Symbolics.substitute.(series, dt_sym =&gt; dt)
  modified_f, _ = build_function(series, u_sym, expression=Val(false))
  modified_ode = ODEProblem((u, params, t) -&gt; modified_f(u), ode.u0, tspan)
  modified_sol_euler = solve(modified_ode, Euler(), dt=dt)
  plot!(fig, modified_sol_euler, vars=(2, 1),
        label=&quot;Euler, modified ODE order $(truncation_order-1)&quot;)
end
plot!(fig, xlims=(0.0, 4.0), ylims=(0.0, 2.5))</code></pre><p><img src="../lotka_volterra_modified.svg" alt/></p><p>We see that if we include one additional term, the resulting trajectory still grows, while with two additional terms the solution appears to be dissipative. With each additional term, the solution gets closer to the exact solution of the original problem, and with three added terms it is hard to see the difference between them at this scale.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>Philippe Chartier, Ernst Hairer and Gilles Vilmart (2007)   Numerical integrators based on modified differential equations   <a href="https://doi.org/10.1090/S0025-5718-07-01967-9">DOI: 10.1090/S0025-5718-07-01967-9</a></p><p>Philippe Chartier, Ernst Hairer, Gilles Vilmart (2010)   Algebraic Structures of B-series.   Foundations of Computational Mathematics   <a href="https://doi.org/10.1007/s10208-010-9065-1">DOI: 10.1007/s10208-010-9065-1</a></p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-ChartierHairerVilmart2007"><a class="tag is-link" href="#citeref-ChartierHairerVilmart2007">ChartierHairerVilmart2007</a></li><li class="footnote" id="footnote-ChartierHairerVilmart2010"><a class="tag is-link" href="#citeref-ChartierHairerVilmart2010">ChartierHairerVilmart2010</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../modified_equations/">« Modified equations</a><a class="docs-footer-nextpage" href="../symbolic_computations/">Symbolic computations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.7 on <span class="colophon-date" title="Wednesday 13 October 2021 07:17">Wednesday 13 October 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
